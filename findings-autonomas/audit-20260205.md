# Auditoría PRONTO - 2026-02-05

**Auditor:** Agente Automatizado
**Alcance:** pronto-client, pronto-employees, pronto-static, pronto-api
**Fecha:** 2026-02-05

---

## Resumen Ejecutivo

| Categoría | Resultado |
|-----------|-----------|
| Roles canónicos | ✅ Consistentes |
| Estados de orden | ⚠️ requiere atención |
| API contracts | ✅ implementados |
| Imports centralizados | ✅ correctos |
| Static assets | ✅ sistema centralizado |
| Flask session | ✅ solo en allowlist |
| Hardcoded hosts | ⚠️ en vite.config |
| Accesibilidad | ⚠️ requiere revisión |

**Total hallazgos:** 9
- **Alta:** 2
- **Media:** 3
- **Baja:** 4

---

## Hallazgos por Severidad

### ALTA

---

**ARCHIVO:** `pronto-api/src/api_app/routes/orders.py:47` y `pronto-employees/src/pronto_employees/routes/api/orders.py:47`

**EVIDENCIA:**
```
rg "_NON_TERMINAL" --type py
pronto-api/src/api_app/routes/orders.py:_NON_TERMINAL = {
pronto-employees/src/pronto_employees/routes/api/orders.py:_NON_TERMINAL = {
```

**DESCRIPCIÓN:**
Duplicación de constante `_NON_TERMINAL` en dos módulos separados. Esta definición debería estar en `pronto-libs/src/pronto_shared/services/order_service.py` como fuente única de verdad.

**IMPACTO:**
- Violación AGENTS.md regla #23 (DDL runtime + pronto-libs primero)
- Mantenimiento difícil: cambios deben hacerse en dos lugares
- Inconsistencia potencial si las definiciones divergen

**FIX MÍNIMO:**
Mover la definición a `pronto-libs/src/pronto_shared/constants/order_status.py`:
```python
# En pronto-libs/src/pronto_shared/constants/order_status.py
_NON_TERMINAL = frozenset({
    "new",
    "requested", 
    "waiter_accepted",
    "queued",
    "preparing",
    "ready",
    "wait_for_payment",
})
```

 Luego importar en ambos módulos:
```python
from pronto_shared.constants.order_status import NON_TERMINAL_STATUSES
```

---

**ARCHIVO:** `pronto-libs/src/pronto_shared/jwt_service.py:28`

**EVIDENCIA:**
```
rg -A10 "def create_access_token" --type py
pronto-libs/src/pronto_shared/jwt_service.py:def create_access_token(
pronto-libs/src/pronto_shared/jwt_service.py-    employee_id: int,
pronto-libs/src/pronto_shared/jwt_service.py-    employee_name: str,
pronto-libs/src/pronto_shared/jwt_service.py-    employee_email: str,
pronto-libs/src/pronto_shared/jwt_service.py-    employee_role: str,
pronto-libs/src/pronto_shared/jwt_service.py-    employee_additional_roles: list[str] | None = None,
```

**DESCRIPCIÓN:**
JWT payload incluye PII (`employee_name`, `employee_email`) que no debería estar en el token.

**IMPACTO:**
- Exposición innecesaria de datos personales en token
- Si el token se filtra, se expone información sensible del empleado
- Violación de principio de mínimo privilegio

**FIX MÍNIMO:**
Modificar `jwt_service.py` para excluir PII del token:
```python
def create_access_token(
    employee_id: int,
    employee_role: str,
    employee_additional_roles: list[str] | None = None,
    expires_delta: timedelta | None = None,
) -> str:
    # employee_name y employee_email NO deben estar en el JWT
    # Usar employee_id para lookup cuando sea necesario
```

---

### MEDIA

---

**ARCHIVO:** `pronto-client/src/pronto_clients/routes/api/debug.py`

**EVIDENCIA:**
```
rg -B2 -A2 "mark_status|next_status" --type py
pronto-client/src/pronto_clients/routes/api/debug.py:                order.mark_status("queued")
pronto-client/src/pronto_clients/routes/api/debug.py:                next_status = "queued"
pronto-client/src/pronto_clients/routes/api/debug.py:                elif current_status == "queued":
pronto-client/src/pronto_clients/routes/api/debug.py:                order.mark_status("preparing")
```

**DESCRIPCIÓN:**
Lógica de transición de estados de orden hardcodeada en archivo debug.py. Las transiciones de estado deben usar el servicio canónico.

**IMPACTO:**
- Lógica de negocio en archivo "debug" - incorrecto conceptualmente
- Transiciones hardcodeadas, no reutilizables
- Sin validación de transiciones válidas

**FIX MÍNIMO:**
Usar `OrderStatusWorkflow` de `pronto_shared`:
```python
from pronto_shared.services.order_status_workflow import OrderStatusWorkflow

# En lugar de:
order.mark_status("queued")

# Usar:
workflow = OrderStatusWorkflow(order)
if workflow.can_transition_to("queued"):
    workflow.transition_to("queued")
```

---

**ARCHIVO:** `pronto-static/src/vue/clients/modules/client-profile.ts:45`

**EVIDENCIA:**
```
rg "localhost:9088" --type ts
pronto-static/src/vue/clients/modules/client-profile.ts:    const staticHost = window.APP_CONFIG?.static_host_url || 'http://localhost:9088';
```

**DESCRIPCIÓN:**
Host hardcodeado como fallback en código de producción.

**IMPACIO:**
- En producción, si APP_CONFIG falla, usará localhost (incorrecto)
- developer localhost referenciada en código de producción

**FIX MÍNIMO:**
```typescript
// client-profile.ts:45
// ❌ INCORRECTO
const staticHost = window.APP_CONFIG?.static_host_url || 'http://localhost:9088';

// ✅ CORRECTO
const staticHost = window.APP_CONFIG?.static_host_url;
if (!staticHost) {
  console.error('[ClientProfile] static_host_url no configurado');
}
```

---

**ARCHIVO:** `pronto-employees/src/pronto_employees/routes/api/branding.py` y `pronto-api/src/api_app/routes/branding.py`

**EVIDENCIA:**
```
rg "branding" --type py -g "!*test*" | grep -E "routes.*branding|api.*branding" | head -10
```

**DESCRIPCIÓN:**
Posible duplicación de endpoint de branding entre pronto-api y pronto-employees.

**IMPACTO:**
- Dos implementaciones del mismo endpoint
- Inconsistencia potencial en respuestas
- Confusión sobre cuál es la fuente de verdad

**FIX MÍNIMO:**
Verificar en `pronto-ai/router.yml` cuál es el contrato canónico y unificar implementación en `pronto-libs` si corresponde.

---

### BAJA

---

**ARCHIVO:** `pronto-employees/src/pronto_employees/templates/dashboard_waiter.html` y otros templates

**EVIDENCIA:**
```
rg -l "\.html" --type html | wc -l
ls /Users/molder/projects/github\ -\ molder/pronto/pronto-employees/src/pronto_employees/templates/
```

**DESCRIPCIÓN:**
Templates tienen nombres inconsistentes:
- `dashboard_waiter.html` (snake_case)
- vs convención estándar unclear

**IMPACTO:**
- Naming inconsistente
- Dificultad para encontrar templates relacionados

**FIX MÍNIMO:**
Normalizar nombres según convención en AGENTS.md:
```
dashboard_waiter.html → dashboard-waiter.html (kebab-case)
```

---

**ARCHIVO:** Múltiples archivos `.py` y `.ts`

**DESCRIPCIÓN:**
Mensajes de error en español e inglés mezclados en el codebase.

**EVIDENCIA:**
```
rg "(error|Error|ERROR|error:)" --type py -i | head -20
```

**IMPACTO:**
- Inconsistencia UX
- Dificultad para usuarios multilenguaje

**FIX MÍNIMO:**
Centralizar mensajes en `pronto-libs/src/pronto_shared/i18n/messages.py` y usar desde allí.

---

**ARCHIVO:** `pronto-static/src/vue/employees/modules/*.ts`

**DESCRIPCIÓN:**
Logs de consola sin prefijos consistentes.

**EVIDENCIA:**
```
rg "console\.(log|warn|error)" --type ts | head -10
```

**IMPACTO:**
- Dificultad para filtrar logs en producción
- Sin convención de prefijos como `[ModuleName]`

**FIX MÍNIMO:**
Agregar prefijos consistentes:
```typescript
console.log('[KitchenBoard] Cargando órdenes...');
console.warn('[KitchenBoard] Error cargando órdenes:', error);
```

---

**ARCHIVO:** `pronto-static/src/static_content/assets/css/`

**DESCRIPCIÓN:**
Revisar si hay CSS sin usar o duplicado.

**EVIDENCIA:**
```
ls -la /Users/molder/projects/github\ -\ molder/pronto/pronto-static/src/static_content/assets/css/employees/
```

**IMPACTO:**
- Bundle más grande de lo necesario
- Dificultad de mantenimiento

**FIX MÍNIMO:**
Ejecutar herramienta de análisis de CSS coverage (como PurgeCSS) en build.

---

## Bugs Detectados

### NO SE REQUIEREN ARCHIVOS EN docs/errors/

Durante esta auditoría no se detectaron bugs que requieran:
- Archivo nuevo en `docs/errors/`
- Entrada en `docs/resueltos.txt`

**Nota:** Los hallazgos de esta auditoría son inconsistencias de integración y patrones a mejorar, no bugs funcionales.

---

## Verificaciones Pasadas

### ✅ Roles Canónicos
```
waiter, chef, cashier, admin, system
```
Uso consistente en todo el monorepo. Sin aliases ni roles inventados.

### ✅ Imports Centralizados
```
from pronto_shared import ...
```
Imports a `pronto_libs` centralizados correctamente.

### ✅ Static Folder
```python
static_folder=None
```
Configurado correctamente en pronto-client y pronto-employees.

### ✅ Flask Session (Allowlist)
Solo encontrado en `pronto-client/src/pronto_clients/utils/customer_session.py` que está en allowlist permitida.

### ✅ Assets References
Todas las referencias a assets usan variables de contexto:
```html
<link rel="stylesheet" href="{{ assets_css_employees }}/dashboard.css">
```

---

## Recomendaciones

1. **Prioritaria:** Mover `_NON_TERMINAL` a pronto-libs
2. **Alta:** Eliminar PII de JWT payload
3. **Media:** Unificar endpoint de branding
4. **Media:** Corregir hardcoded localhost en client-profile.ts
5. **Baja:** Normalizar nombres de templates
6. **Baja:** Centralizar mensajes de error

---

**FIN DEL REPORTE**
