# Findings Autonomas - 2026-02-05

Alcance: pronto-client, pronto-employees, pronto-static, pronto-api.

## Cambios aplicados (integracion / UX)

### 1) Contrato source-of-truth: `/api/orders` (employees BFF)

- Implementado `GET /api/orders` en `pronto-employees` como contrato publico para UI.
- Soporta filtros:
  - `status=...` (repetible)
  - `paid_recent_minutes=N` (filtra exclusivamente por `paid_at`; excluye `paid_at NULL`)
- Incluye `warnings[]` cuando detecta mezcla `paid + NON_TERMINAL` por `session_id` (warning+log; no bloquea GET).

Evidencia (paths):
- `pronto-employees/src/pronto_employees/routes/api/orders.py`
- `pronto-employees/src/pronto_employees/app.py`

### 2) Eliminacion de endpoints legacy para “estado de sesion”

- Removida referencia UI a endpoint legacy de "sesiones esperando pago" (estado).
- Derivacion de estado por `session_id` agrupando ordenes (`workflow_status`).

Evidencia:
- No hay referencias a endpoints legacy de estado en `pronto-static/src/vue/employees` (verificado por grep).

### 3) Helper unico de derivacion de sesiones (pronto-static)

- Nuevo helper: deriva estado de sesion y `paid_recent` desde ordenes.

Evidencia:
- `pronto-static/src/vue/shared/lib/session_state.ts`
- usado en:
  - `pronto-static/src/vue/employees/modules/kitchen-board.ts`
  - `pronto-static/src/vue/employees/modules/waiter-board.ts`
  - `pronto-static/src/vue/employees/modules/sessions-manager.ts`
  - `pronto-static/src/vue/employees/components/ClosedSessionsManager.vue`

### 4) Timestamps de movimientos de estado

- En cada cambio de estado se guarda fecha/hora:
  - `OrderStatusHistory.changed_at` en cada `mark_status`
  - `paid_at` obligatorio cuando `workflow_status=paid`

Evidencia:
- `pronto-libs/src/pronto_shared/models.py`

### 5) QA / anti-drift

- Actualizado `pronto-scripts/scripts/qa/qa_verify_paid_tab.py` para usar `/api/orders` (ya no usa endpoint legacy de paid-recent).
- Actualizado `pronto-scripts/scripts/qa/test_order_flow.sh`:
  - precheck `rg` para endpoints legacy
  - login empleado y verificacion minima de `GET /api/orders?status=queued`

## Pendientes recomendados

- Ejecutar Playwright + API tests en `pronto-tests` para validar flujos completos (login employees, kitchen board, pagos).
- Confirmar que no existan referencias restantes a endpoints legacy en scripts/docs fuera de pronto-static.
