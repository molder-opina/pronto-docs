ID: SEC-20260215-007
FECHA: 2026-02-15
PROYECTO: pronto-api
SEVERIDAD: alta
TITULO: PII (nombre, email) incluido en JWT claims de empleados

DESCRIPCION:
Los tokens JWT de empleados incluyen PII en los claims:
- employee_name
- employee_email

Estos datos quedan expuestos en:
1. Cookies del browser (visible al hacer decode del JWT)
2. Logs de servidor/proxies
3. Posibles fugas de información por debugging

Los tokens JWT son stateless y pueden ser decodificados por cualquier persona que tenga acceso a la cookie. Incluir PII en el token viola el principio de mínima exposición.

PASOS_REPRODUCIR:
1. Hacer login como empleado
2. Leer cookie access_token
3. Decodificar JWT (base64)
4. Ver employee_name y employee_email en payload

RESULTADO_ACTUAL:
jwt_service.py create_access_token() líneas 104-117:
payload = {
    "employee_id": employee_id,
    "employee_name": employee_name,     # PII
    "employee_email": employee_email,    # PII
    "employee_role": employee_role,
    ...
}

RESULTADO_ESPERADO:
JWT access token solo debe contener:
- employee_id
- employee_role
- active_scope
- jti, iat, exp, type
- iss, aud (cuando se implemente SEC-004)

 employee_name y employee_email se consultan server-side cuando se necesitan (con cache si es necesario)

UBICACION:
- pronto-libs/src/pronto_shared/jwt_service.py:104-117

EVIDENCIA:
- Línea 112-113 en jwt_service.py:
  "employee_name": employee_name,
  "employee_email": employee_email,

HIPOTESIS_CAUSA:
Implementación inicial incluyó datos completos del empleado en el token para evitar consultas adicionales. Convenience sobre seguridad.

ESTADO: RESUELTO

SOLUCION:
1. create_access_token() ahora tiene include_pii=False por defecto
2. No se incluye employee_name/employee_email en el token por defecto
3. Para incluir PII, pasar include_pii=True explicitamente
4. Warning en log si se pasan parametros PII pero no se usan

Impacto: tokens actuales seguiran funcionando. Codigo que use
user.get("name") necesitara actualizarse para obtener nombre de DB.

Para migrate gradualmente:
- Los endpoints que necesiten nombre/email del empleado
  deben obtenerlos de la DB usando employee_id

COMMIT: jwt_service.py modificado
FECHA_RESOLUCION: 2026-02-15
